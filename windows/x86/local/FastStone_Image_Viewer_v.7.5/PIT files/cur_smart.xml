<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 	xsi:schemaLocation="http://peachfuzzer.com/2012/Peach ../peach.xsd">
	<!-- Define our file format -->
	<DataModel name="Cur">
		<Block name="Signature" minOccurs="1" maxOccurs="1">
			<!-- Reserved + Type (expressed in Little Endian Format) -->
			<String name="CurSignature" value="0x00000200" valueType="hex" token="true" mutable="false"/> 
			<Number name="ImageCount" size="16" endian="little" signed="false">
				<!-- ImageCount express the number of images contained by the .CUR file  -->
				<Relation type="count" of="Entries" />
				<Relation type="count" of="Image" />
			</Number>
		</Block>
		<Block name="Entries" minOccurs="0" length="16">
			<Number name="Width" size="8" endian="little" signed="false"/>
			<Number name="Height" size="8" endian="little" signed="false"/>
			<Number name="ColorCount" size="8" endian="little" signed="false"/>
			<Number name="Reserved" size="8" endian="little" signed="false"/>
			<Number name="xHotSpot" size="16" endian="little" signed="false"/>
			<Number name="yHotSpot" size="16" endian="little" signed="false"/>
			<Number name="SizeinBytes" size="32" endian="little" signed="false">
				<!-- ImageBlob.size=SizeinBytes-InfoHeader.length  -->
				<Relation type="size" of="Image" />
			</Number>	
			<Number name="FileOffset" size="32" endian="little" signed="false"/>
		</Block>
		<Block name="Image" minOccurs="0">
			<!-- InfoHeader -->
			<Number name="Size" size="32" endian="little" signed="false"/>
			<Number name="Width" size="32" endian="little" signed="false"/>
			<Number name="Height" size="32" endian="little" signed="false"/>
			<Number name="Planes" size="16" endian="little" signed="false"/>
			<Number name="BitCount" size="16" endian="little" signed="false"/>
			<Number name="Compression" size="32" endian="little" signed="false"/>
			<Number name="ImageSize" size="32" endian="little" signed="false"/>
			<Number name="XpixelsPerM" size="32" endian="little" signed="false"/>
			<Number name="YpixelsPerM" size="32" endian="little" signed="false"/>
			<Number name="ColorsUsed" size="32" endian="little" signed="false"/>
			<Number name="ColorsImportant" size="32" endian="little" signed="false"/>
			<!-- Image Data -->
			<Blob name="ImageBlob"/>
		</Block>
	</DataModel>
	<!-- Define a simple state machine that will write the file and 
		then launch a program using the FileWriterLauncher publisher -->
	<StateModel name="State" initialState="Initial">
		<State name="Initial">
			<!-- Write out contents of file -->
			<Action type="output">
				<DataModel ref="Cur" />
				<!-- Directory from where to load test cases to mutate -->
                <Data name="data" fileName="C:\peach\samples/*.cur"/>
			</Action>
			<!-- Close file -->
			<Action type="close" />
			<!-- Launch the file consumer -->
			<Action type="call" method="LaunchViewer" publisher="Peach.Agent"/>
		</State>
	</StateModel>
    <Agent name="WinAgent">
        <Monitor class="WindowsDebugger">
            <!-- Target process and command line to open "fuzzed" test case -->
            <Param name="CommandLine" value="C:\Program Files (x86)\FastStone Image Viewer\FSViewer.exe fuzz.cur" />
            <!-- WinDbg folder -->
            <Param name="WinDbgPath" value="C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\" />
            <Param name="StartOnCall" value="LaunchViewer" />
        </Monitor>
        <Monitor class="PageHeap">
            <!-- Target process name -->
            <Param name="Executable" value="FSViewer.exe"/>
            <!-- WinDbg folder -->
            <Param name="WinDbgPath" value="C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\" />
        </Monitor>
    </Agent>
    <Test name="Default">
        <Agent ref="WinAgent" platform="windows"/>
        <StateModel ref="State"/>
        <Publisher class="File">
			<!-- "Fuzzed" Test Case Name-->
			<Param name="FileName" value="fuzz.cur" />
        </Publisher>
		<Logger class="Filesystem">
            <!-- Crashes Folder Location -->
            <Param name="Path" value="C:\logs\" />
        </Logger>
    </Test> 
</Peach>
<!-- end -->